<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chess Evaluation UI</title>
  <style>
    body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
    #sidebar { width: 30%; border-right: 1px solid #ccc; overflow-y: auto; padding: 8px; box-sizing: border-box; }
    #main { flex: 1; display: flex; flex-direction: column; padding: 8px; box-sizing: border-box; }
    .game-item { padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; }
    .game-item:hover { background: #f5f5f5; }
    .selected { background: #ddeeff !important; }
    #board { width: 400px; height: 400px; border: 1px solid #333; margin-bottom: 8px; }
    #controls { margin-bottom: 8px; }
    #controls button { margin-right: 4px; }
    #info { font-size: 0.9em; margin-bottom: 8px; }
    #reasoning { white-space: pre-wrap; font-family: monospace; border: 1px solid #ddd; padding: 6px; height: 150px; overflow-y: auto; }
  </style>
  <!-- Use chess.js + a minimal text board renderer (no external chessboard.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
</head>
<body>
  <div id="sidebar">
    <h3>Games (logs)</h3>
    <button onclick="loadGames()">Refresh</button>
    <div id="games"></div>
  </div>
  <div id="main">
    <h2>Game Viewer</h2>
    <div id="info">Select a game from the left to view details.</div>
    <div id="board"></div>
    <div id="controls">
      <button onclick="firstMove()">|&lt;</button>
      <button onclick="prevMove()">&lt;</button>
      <span id="moveIndex">Move: 0</span>
      <button onclick="nextMove()">&gt;</button>
      <button onclick="lastMove()">&gt;|</button>
    </div>
    <h3>Reasoning / Comment</h3>
    <div id="reasoning"></div>
  </div>

  <script>
    let games = [];
    let currentGame = null;
    let currentIndex = 0; // ply index

    async function loadGames() {
      try {
        const resp = await fetch('/api/games');
        const data = await resp.json();
        games = data.games || [];
        renderGameList();
      } catch (e) {
        console.error('Failed to load games', e);
      }
    }

    function renderGameList() {
      const container = document.getElementById('games');
      container.innerHTML = '';
      games.forEach((g) => {
        const div = document.createElement('div');
        div.className = 'game-item';
        div.textContent = `${g.timestamp || ''} | vs ${g.opponent} | ${g.player_color} | ${g.result} | ACPL: ${g.player_acpl?.toFixed?.(1) ?? g.player_acpl}`;
        div.onclick = () => selectGame(g.id, div);
        container.appendChild(div);
      });
    }

    async function selectGame(id, elem) {
      // highlight selection
      document.querySelectorAll('.game-item').forEach((el) => el.classList.remove('selected'));
      if (elem) elem.classList.add('selected');

      try {
        const resp = await fetch(`/api/games/${encodeURIComponent(id)}`);
        const data = await resp.json();
        currentGame = data;
        currentIndex = 0;
        updateInfo();
        renderBoard();
        renderReasoning();
      } catch (e) {
        console.error('Failed to load game detail', e);
      }
    }

    function updateInfo() {
      if (!currentGame) return;
      const info = document.getElementById('info');
      info.textContent = `Game ${currentGame.id} | vs ${currentGame.opponent} | ${currentGame.player_color} | ${currentGame.result} | Player ACPL: ${currentGame.player_acpl?.toFixed?.(1) ?? currentGame.player_acpl}, Opponent ACPL: ${currentGame.opponent_acpl?.toFixed?.(1) ?? currentGame.opponent_acpl}`;
    }

    function renderBoard() {
      const boardDiv = document.getElementById('board');
      if (!currentGame) {
        boardDiv.textContent = '(no game selected)';
        return;
      }
      const positions = currentGame.positions || [];
      const fen = positions[Math.min(currentIndex, positions.length - 1)] || positions[0];
      if (!fen) {
        boardDiv.textContent = '(no positions)';
        return;
      }
      const chess = new Chess(fen);
      const boardStr = chess.ascii();
      boardDiv.textContent = boardStr;
      document.getElementById('moveIndex').textContent = `Move: ${currentIndex}`;
    }

    function renderReasoning() {
      const box = document.getElementById('reasoning');
      if (!currentGame) {
        box.textContent = '';
        return;
      }
      const comments = currentGame.move_comments || [];
      const idx = Math.max(0, Math.min(currentIndex - 1, comments.length - 1));
      box.textContent = comments[idx] || '(no comment for this move)';
    }

    function firstMove() {
      if (!currentGame) return;
      currentIndex = 0;
      renderBoard();
      renderReasoning();
    }

    function prevMove() {
      if (!currentGame) return;
      currentIndex = Math.max(0, currentIndex - 1);
      renderBoard();
      renderReasoning();
    }

    function nextMove() {
      if (!currentGame) return;
      const maxIndex = (currentGame.positions?.length || 1) - 1;
      currentIndex = Math.min(maxIndex, currentIndex + 1);
      renderBoard();
      renderReasoning();
    }

    function lastMove() {
      if (!currentGame) return;
      currentIndex = (currentGame.positions?.length || 1) - 1;
      renderBoard();
      renderReasoning();
    }

    // Initial load
    loadGames();
  </script>
</body>
</html>
